{extend name="Public:base" /}
{block name="content"}
<div class="layui-fluid">
  <div class="layui-card">
    <div class="layui-card-header">{$title}</div>
    <div class="layui-card-header layuiadmin-card-header-auto">
      <div class="layui-form" >
        <div class="layui-input-inline">
          <input type="text" name="user_name" id="user_name" placeholder="请输入姓名" class="layui-input">
        </div>
        <div class="layui-input-inline">
          <input type="text" name="number" id="number" placeholder="请输入编号" class="layui-input">
        </div>
<!--        <div class="layui-input-inline">-->
<!--          <select name="name" >-->
<!--            <option value="">&#45;&#45;请选择机构&#45;&#45;</option>-->
<!--            {foreach $info as $k=>$v}-->
<!--            <option  value="{$v.name}">{$v.name}</option>-->
<!--            {/foreach}-->
<!--          </select>-->
<!--        </div>-->
        <button class="layui-btn" data-type="reload" id="searchBtn">搜索</button>
        <a class="layui-btn"  href="javascript:;" id="add">添加</a>
        <button class="layui-btn  layui-btn-danger" id="listDelete">删除</button>
      </div>

    </div>
    <div class="layui-card-body">
      <table id="dataTable" lay-filter="dataTable"></table>
      <script type="text/html" id="options">
        <div class="layui-btn-group">
          <a class="layui-btn layui-btn-sm" lay-event="edit">编辑</a>
<!--          <a class="layui-btn layui-btn-danger layui-btn-sm" lay-event="del">删除</a>-->
          <a class="layui-btn  layui-btn-sm" lay-event="yibanzhuangkaung">患者状况</a>
          <a class="layui-btn  layui-btn-sm" lay-event="create">手术状况</a>
          <a class="layui-btn  layui-btn-sm" lay-event="visit">随访记录</a>
        </div>
      </script>
      <script type="text/html" id="position">
        @{{ d.position.name }}
      </script>
      <script type="text/html" id="thumb">
        <a href="@{{d.thumb}}" target="_blank" title="点击查看"><img src="@{{d.thumb}}" alt="" width="28" height="28"></a>
      </script>
    </div>
  </div>
</div>
{/block}
{block name="script"}
<script>
  layui.use(['layer','table','form','jquery'],function () {
    var $ = layui.$;
    var layer = layui.layer;
    var form = layui.form;
    var table = layui.table;
    //用户表格初始化
    var dataTable = table.render({
      elem: '#dataTable'
      ,height: $(window).height() - 150
      ,url: "{:url('@home/patient/invest_data')}" //数据接口
      ,page: true //开启分页
      ,cols: [[ //表头
        {checkbox: true,fixed: true}
        ,{field: 'id', title: '序号', sort: true,width:80}
        ,{field: 'user_name', title: '患者姓名'}
        ,{field: 'user_num_id', title: 'ID号'}
        ,{field: 'name', title: '机构名称'}
        ,{field: 'operation', title: '手术'}
        ,{field: 'wtid', title: '外科医生'}
        ,{field: 'opera_date', title: '手术日期'}
        ,{field: 'create_time', title: '下次随访时间'}
        ,{fixed: 'right', width: 350, align:'center', toolbar: '#options'}
      ]]
      , limit: 18
      , id: 'testReload'
    });

    //监听工具条
    table.on('tool(dataTable)', function(obj){ //注：tool是工具条事件名，dataTable是table原始容器的属性 lay-filter="对应的值"
      var data = obj.data, //获得当前行数据
          layEvent = obj.event; //获得 lay-event 对应的值
      /*if(layEvent === 'del'){
        layer.confirm('确认删除吗？', function(index){
          $.post("{:url('@home/patient/invest_destroy')}",{_method:'delete',ids:[data.id]},function (result) {
            if (result.code==0){
              obj.del(); //删除对应行（tr）的DOM结构
            }
            layer.close(index);
            layer.msg(result.msg,{icon:6})
          });
        });
      } */
      if(layEvent === 'edit'){
        var url = "{:url('@home/patient/invest_add')}?id="+data.id;
        layer.open({
          type: 2,
          title: '编辑患者基本信息',
          area: ['90%', '90%'],
          maxmin:true,
          fixed: true, //不固定
          closeBtn: 1,
          content: [url],
          end: function () {
            table.reload('testReload');
          }
        });
      }else if(layEvent === 'yibanzhuangkaung'){
        var url = "{:url('@home/patient/invest_yiban')}?id="+data.id;
        layer.open({
          type: 2,
          title: '患者状况',
          area: ['90%', '90%'],
          fixed: true, //不固定
          closeBtn: 1,
          content: [url],
          end: function () {
            table.reload('testReload');
          }
        });
      }else if(layEvent === 'create'){
        var url = "{:url('@home/patient/create_add')}?id="+data.id;
        layer.open({
          type: 2,
          title: '编辑手术情况',
          area: ['90%', '90%'],
          fixed: true, //不固定
          closeBtn: 1,
          content: [url],
          end: function () {
            table.reload('testReload');
          }
        });
      }else if(layEvent === 'visit'){
        var url = "{:url('@home/patient/visit')}?id="+data.id;
        layer.open({
          type: 2,
          title: '随访记录',
          area: ['90%', '90%'],
          fixed: true, //不固定
          closeBtn: 1,
          content: [url],
          end: function () {
            table.reload('testReload');
          }
        });
      }
    });
    //按钮批量删除
    /*$("#listDelete").click(function () {
      var ids = []
      var hasCheck = table.checkStatus('dataTable')
      var hasCheckData = hasCheck.data
      if (hasCheckData.length>0){
        $.each(hasCheckData,function (index,element) {
          ids.push(element.id)
        })
      }
      if (ids.length>0){
        layer.confirm('确认删除吗？', function(index){
          $.post("{:url('@home/patient/invest_destroy')}",{_method:'delete',ids:ids},function (result) {
            if (result.code==0){
              dataTable.reload()
            }
            layer.close(index);
            layer.msg(result.msg,{icon:6})
          });
        })
      }else {
        layer.msg('请选择删除项',{icon:5})
      }
    });*/

    var $ = layui.$, active = {
      reload: function () {
        //执行重载
        table.reload('testReload', {
          page: {
            curr: 1 //重新从第 1 页开始
          }
          , where: {
            user_name: $('#user_name').val(),
            number: $('#number').val(),
          }
        });
      }
    };
    //搜索
    $('#searchBtn').on('click', function () {
      var type = $(this).data('type');
      active[type] ? active[type].call(this) : '';
    });

    $('#add').click(function () {
      var url = "{:url('/home/patient/invest_add')}" ;
      layer.open({
        type: 2,
        title: '添加患者基本信息',
        area: ['90%', '90%'],
        fixed: true, //不固定
        closeBtn: 1,
        content: [url],
        end: function () {
          table.reload('testReload');
        }
      });
    });
  })
</script>
{/block}